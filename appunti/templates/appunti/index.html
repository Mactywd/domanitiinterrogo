{% extends "base.html" %}

{% block title %}Appunti{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">Appunti</h1>

    <!-- Tabs -->
    <ul class="nav nav-tabs" id="appuntiTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="materia-tab" data-bs-toggle="tab" data-bs-target="#materia" type="button" role="tab">
                Per Materia
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="data-tab" data-bs-toggle="tab" data-bs-target="#data" type="button" role="tab">
                Per Data
            </button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content mt-3" id="appuntiTabContent">
        <!-- Per Materia -->
        <div class="tab-pane fade show active" id="materia" role="tabpanel">
            <div class="mb-3">
                <label for="materiaSelect" class="form-label">Seleziona Materia</label>
                <select id="materiaSelect" class="form-select" onchange="showMateria(this.value)">
                    <option value="">-- Seleziona --</option>
                    {% for materia in materie %}
                        <option value="{{ materia.id }}">{{ materia.nome }}</option>
                    {% endfor %}
                </select>
            </div>

            {% for materia, mesi in appunti_per_materia.items %}
                <div class="materia-block" id="materia-{{ materia.id }}" style="display: none;">
                    {% for mese, appunti in mesi.items %}
                        <h5 class="mt-3">{{ mese|title }}</h5>
                        <div class="row">
                            {% for appunto in appunti %}
                            <div class="col-md-4 mb-3">
                                <a href="/appunti/{{ appunto.id }}/" class="text-decoration-none">
                                    <div class="card shadow-sm h-100">
                                        <div class="card-body d-flex justify-content-between align-items-center">
                                            <span class="fw-bold">{{ appunto.titolo }}</span>
                                            <span class="text-muted">{{ appunto.data|date:"j F" }}</span>
                                        </div>
                                    </div>
                                </a>
                            </div>
                            {% endfor %}
                        </div>
                    {% endfor %}
                </div>
            {% endfor %}
        </div>

        <!-- Per Data -->
        <div class="tab-pane fade" id="data" role="tabpanel">
            <div class="mb-3">
                <label for="dataSelect" class="form-label">Seleziona Data</label>
                <input type="date" id="dataSelect" class="form-control" onchange="showData(this.value)">
            </div>
            <div id="dataResults"></div>
        </div>

<!-- Bottone "+" in basso a destra (solo per admin) -->
{% if user.is_staff %}
<button type="button" class="btn btn-primary rounded-circle"
        style="position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; font-size: 24px;"
        data-bs-toggle="modal" data-bs-target="#addAppuntoModal">
    +
</button>
{% endif %}

<!-- Modal Aggiunta Appunto -->
{% if user.is_staff %}
<div class="modal fade" id="addAppuntoModal" tabindex="-1" aria-labelledby="addAppuntoModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="POST" action="{% url 'appunti:add' %}">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="addAppuntoModalLabel">Aggiungi Appunto</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Chiudi"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Titolo</label>
            <input type="text" name="titolo" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Materia</label>
            <div class="mb-3">
            <label class="form-label">Materia</label>
                <select name="materia" class="form-select" required>
                    {% for materia in materie %}
                        <option value="{{ materia.nome }}">{{ materia.nome }}</option>
                    {% endfor %}
                </select>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">Data</label>
            <input type="date" name="data" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Contenuto</label>
            <textarea name="contenuto" rows="5" class="form-control" required></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
          <button type="submit" class="btn btn-primary">Salva</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endif %}
{% endblock %}
{% block script %}
<script>
const allData = {{ appunti_per_data_json|safe }};

function showMateria(id) {
    document.querySelectorAll(".materia-block").forEach(el => el.style.display = "none");
    if (id) {
        document.getElementById("materia-" + id).style.display = "block";
    }
}

function showData(date) {
    const container = document.getElementById("dataResults");
    container.innerHTML = "";
    if (date && allData[date]) {
        allData[date].forEach(appunto => {
            const col = document.createElement("div");
            col.className = "col-md-4 mb-3";
            col.innerHTML = `
                <a href="/appunti/${appunto.id}/" class="text-decoration-none">
                    <div class="card shadow-sm h-100">
                        <div class="card-body d-flex justify-content-between align-items-center">
                            <span class="fw-bold">${appunto.titolo}</span>
                            <span class="text-muted">${appunto.materia}</span>
                        </div>
                    </div>
                </a>
            `;
            container.appendChild(col);
        });
    }
}
</script>
{% endblock %}
